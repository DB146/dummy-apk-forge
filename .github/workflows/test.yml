name: Decompile APK (JADX)

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Direct download URL for the APK file'
        required: true
        type: string

permissions:
  contents: write

jobs:
  decompile-jadx:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install JADX
        run: |
          # Use a newer version if available
          wget -q https://github.com/skylot/jadx/releases/download/v1.5.0/jadx-1.5.0.zip
          unzip -q jadx-1.5.0.zip -d jadx-tool
          chmod +x jadx-tool/bin/jadx
          echo "$(pwd)/jadx-tool/bin" >> $GITHUB_PATH
      
      - name: Download APK
        env:
          APK_URL: ${{ inputs.apk_url }}
        run: |
          wget -U "Mozilla/5.0" -O app.apk "$APK_URL"
          echo "APK downloaded successfully"
      
      - name: Clean previous builds
        run: rm -rf decompiled-project/
      
      - name: Run JADX Decompiler
        env:
          JAVA_OPTS: "-Xmx6g"
        run: |
          jadx -d decompiled-project \
               --export-gradle \
               --show-bad-code \
               --no-debug-info \
               --no-res \
               --kotlin \
               --threads-count 2 \
               app.apk

      - name: Clean up Large Files (Pre-commit)
        run: |
          # Delete common large files that break Git (Native libs, fonts, media)
          find decompiled-project -name "*.so" -delete
          find decompiled-project -name "*.ttf" -delete
          find decompiled-project -name "*.mp4" -delete
          find decompiled-project -name "*.mp3" -delete
          
          # Cleanup tools
          rm app.apk
          rm -rf jadx-tool
          rm jadx-1.5.0.zip

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: Commit and Push
        env:
          URL_INPUT: ${{ inputs.apk_url }}
        run: |
          git add decompiled-project/
          # Check if there is anything to commit to prevent error
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "JADX Decompilation of $URL_INPUT"
            git push
          fi
